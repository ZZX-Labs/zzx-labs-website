<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Business Resources | ZZX-Labs R&D</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <!-- Reuse site styling / scripts from root -->
  <link rel="stylesheet" href="/static/styles.css" />
  <script src="/static/script.js" defer></script>

  <style>
    /* Page-specific enhancements (kept minimal; inherits your site styles) */
    :root {
      --accent: #c0d674;
      --muted: #8a8f98;
      --bg-alt: #0f1216;
    }
    body.business-resources {
      background: var(--bg-alt);
    }
    .page-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem;
    }
    .breadcrumbs {
      font-size: 0.9rem;
      color: var(--muted);
      margin: 0.5rem 0 1rem 0;
    }
    .breadcrumbs a { color: var(--accent); text-decoration: none; }
    .page-title {
      margin: 0.5rem 0 1rem 0;
    }
    .notice {
      background: rgba(192,214,116,0.06);
      border: 1px solid rgba(192,214,116,0.25);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }
    .layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1.25rem;
    }
    @media (max-width: 1000px) {
      .layout { grid-template-columns: 1fr; }
    }
    /* Sticky TOC */
    .toc {
      position: sticky;
      top: 1rem;
      max-height: calc(100vh - 2rem);
      overflow: auto;
      padding: 1rem;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      background: rgba(0,0,0,0.2);
    }
    .toc h3 { margin-top: 0; color: var(--accent); }
    .toc .source {
      margin: 0.25rem 0 0.5rem 0;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .toc a { color: #ddd; text-decoration: none; }
    .toc ul {
      list-style: none;
      margin: 0.25rem 0 0.75rem 0;
      padding-left: 0.5rem;
      border-left: 2px solid rgba(255,255,255,0.08);
    }
    .toc li { margin: 0.25rem 0; }

    /* Content */
    .sources-container section {
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px dashed rgba(255,255,255,0.08);
    }
    .source-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0 0 0.5rem 0;
    }
    .source-header h2 {
      margin: 0;
      color: var(--accent);
      font-size: 1.5rem;
      line-height: 1.2;
    }
    .source-meta {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .subsection {
      margin: 1rem 0;
    }
    .subsection h3 {
      margin: 1rem 0 0.5rem 0;
      font-size: 1.15rem;
      color: #e8e8e8;
    }
    .loading, .error {
      color: var(--muted);
      font-style: italic;
      margin: 0.5rem 0;
    }
    .api-badge {
      font-size: 0.75rem;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px;
      padding: 0.2rem 0.5rem;
    }
    .updated-time {
      font-size: 0.8rem;
      color: var(--muted);
      margin-left: auto;
    }
    .pill {
      display: inline-block;
      font-size: 0.7rem;
      padding: 0.15rem 0.45rem;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: #bbb;
      margin-left: 0.35rem;
    }
    /* Smooth anchor scroll */
    html { scroll-behavior: smooth; }
  </style>
</head>

<body class="business-resources">
  <!-- Optional: reuse your site header via server includes; minimal header below -->
  <header class="header">
    <div class="container">
      <div class="logo-container">
        <a href="/"><img src="/static/logos/ZZX Logo.png" alt="ZZX Logo" class="logo" /></a>
      </div>
      <nav class="navbar">
        <ul class="nav-links">
          <li><a href="/">Home</a></li>
          <li><a href="/docs">Docs</a></li>
          <li><a href="/docs/README.md">README</a></li>
          <li><a href="/contact">Contact</a></li>
          <li><span class="api-badge">Live from Wikipedia</span></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="page-container">
    <div class="breadcrumbs">
      <a href="/docs">Docs</a> /
      <a href="/docs/staff">Staff</a> /
      <a href="/docs/staff/materials">Materials</a> /
      <strong>Business Resources</strong>
    </div>

    <h1 class="page-title">Business Resources</h1>
    <div class="notice">
      This page renders **live** content from Wikipedia using the MediaWiki API. Each source URL
      becomes a section; its Wikipedia headings become sub-sections. Update <code>urls.json</code>
      (in this folder) to add or remove sources—no manual copy-editing required.
    </div>

    <div class="layout">
      <!-- Sticky in-page TOC -->
      <aside aria-label="Table of contents">
        <nav class="toc" id="toc">
          <h3>On this page</h3>
          <div id="toc-content" class="toc-content">
            <p class="loading">Loading sources…</p>
          </div>
        </nav>
      </aside>

      <!-- Dynamic content target -->
      <div class="sources-container" id="sources"></div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 <strong>ZZX-Labs R&D</strong>. MIT-licensed. Created by <i>[0xdeadbeef]</i>.</p>
    </div>
  </footer>

  <script>
    /**
     * Business-Resources renderer
     * - Reads ./urls.json (array of Wikipedia URLs).
     * - For each URL: derive title, fetch sections, then fetch HTML per section via action=parse.
     * - Sanitizes incoming HTML, rewrites links to full Wikipedia URLs, opens in new tab.
     * - Caches responses in localStorage (TTL default 6h).
     */

    const TOC = document.getElementById('toc-content');
    const TARGET = document.getElementById('sources');

    const TTL_MS = 6 * 60 * 60 * 1000; // 6 hours
    const MW_API = 'https://en.wikipedia.org/w/api.php';
    const ORIGIN = '&origin=*'; // enable CORS
    const HEADERS_TO_INCLUDE = null; // set to array like ['1','2','3'] to filter section indices

    // --- Utility: cache wrapper ---
    const cacheGet = (key) => {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (Date.now() - obj.t > TTL_MS) { localStorage.removeItem(key); return null; }
        return obj.v;
      } catch { return null; }
    };
    const cacheSet = (key, value) => {
      try { localStorage.setItem(key, JSON.stringify({ t: Date.now(), v: value })); } catch {}
    };

    // --- Utility: derive page title from URL ---
    function urlToTitle(url) {
      try {
        const u = new URL(url);
        // handles /wiki/Title and /w/index.php?title=Title
        if (u.pathname.startsWith('/wiki/')) {
          return decodeURIComponent(u.pathname.replace('/wiki/', ''));
        }
        const t = u.searchParams.get('title');
        if (t) return decodeURIComponent(t);
      } catch {}
      // fallback: last path segment
      return decodeURIComponent(String(url).split('/').pop() || '').replace(/_/g,' ');
    }

    // --- API calls ---
    async function fetchParse(params) {
      const url = `${MW_API}?${params}${ORIGIN}`;
      const key = `mw:${params}`;
      const cached = cacheGet(key);
      if (cached) return cached;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      cacheSet(key, json);
      return json;
    }

    async function getSections(pageTitle) {
      const p = new URLSearchParams({
        action: 'parse',
        format: 'json',
        prop: 'sections',
        page: pageTitle
      }).toString();
      const data = await fetchParse(p);
      if (data.error) throw new Error(data.error.info || 'MediaWiki error (sections)');
      return data.parse.sections || [];
    }

    async function getSectionHTML(pageTitle, sectionIndex) {
      const p = new URLSearchParams({
        action: 'parse',
        format: 'json',
        prop: 'text|revid',
        page: pageTitle,
        section: sectionIndex
      }).toString();
      const data = await fetchParse(p);
      if (data.error) throw new Error(data.error.info || 'MediaWiki error (text)');
      return { html: data.parse.text['*'], revid: data.parse.revid };
    }

    async function getPageMeta(pageTitle) {
      const p = new URLSearchParams({
        action: 'query',
        format: 'json',
        prop: 'revisions|info',
        titles: pageTitle,
        rvprop: 'timestamp',
        inprop: 'url'
      }).toString();
      const data = await fetchParse(p);
      const pages = data?.query?.pages || {};
      const first = Object.values(pages)[0];
      const ts = first?.revisions?.[0]?.timestamp;
      const fullurl = first?.fullurl;
      return { updated: ts ? new Date(ts) : null, url: fullurl || null };
    }

    // --- Sanitize incoming HTML (basic) ---
    function sanitizeAndRewrite(html, wikiBaseUrl) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // Remove scripts, styles, meta
      ['script','style','meta','link'].forEach(sel => doc.querySelectorAll(sel).forEach(n => n.remove()));

      // Rewrite anchors: keep external; fix relative to full wiki; open in new tab
      doc.querySelectorAll('a[href]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href) return;
        if (href.startsWith('#')) {
          // make intra-section anchors local
          a.setAttribute('href', href);
        } else if (href.startsWith('/')) {
          a.setAttribute('href', `https://en.wikipedia.org${href}`);
          a.setAttribute('target', '_blank');
          a.setAttribute('rel', 'noopener noreferrer');
        } else if (/^https?:\/\//i.test(href)) {
          a.setAttribute('target', '_blank');
          a.setAttribute('rel', 'noopener noreferrer');
        }
      });

      // Remove edit links and collapse infobox navbox if noisy
      doc.querySelectorAll('.mw-editsection, .toc, .navbox, .metadata').forEach(n => n.remove());

      // Strip inline styles that break dark themes
      doc.querySelectorAll('[style]').forEach(n => n.removeAttribute('style'));

      return doc.body.innerHTML;
    }

    // --- Build UI blocks ---
    function addTOCSourceBlock(srcId, title, sections) {
      const wrap = document.createElement('div');
      wrap.className = 'toc-source';
      const h = document.createElement('div');
      h.className = 'source';
      const link = document.createElement('a');
      link.href = `#${srcId}`;
      link.textContent = title.replace(/_/g,' ');
      h.appendChild(link);
      wrap.appendChild(h);

      const list = document.createElement('ul');
      sections.forEach(s => {
        if (s.toclevel === 0) return; // skip root if present
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${srcId}--sec-${s.index}`;
        a.textContent = s.line;
        li.appendChild(a);
        list.appendChild(li);
      });
      wrap.appendChild(list);
      TOC.appendChild(wrap);
    }

    function renderSourceHeader(container, srcId, title, pageUrl, updated) {
      const section = document.createElement('section');
      section.id = srcId;

      const head = document.createElement('div');
      head.className = 'source-header';

      const h2 = document.createElement('h2');
      const a = document.createElement('a');
      a.href = pageUrl || `https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`;
      a.textContent = title.replace(/_/g,' ');
      a.target = '_blank'; a.rel = 'noopener noreferrer';
      h2.appendChild(a);

      const badge = document.createElement('span');
      badge.className = 'pill';
      badge.textContent = 'Wikipedia';

      const updatedSpan = document.createElement('span');
      updatedSpan.className = 'updated-time';
      updatedSpan.textContent = updated ? `Last updated: ${updated.toLocaleString()}` : '';

      head.appendChild(h2);
      head.appendChild(badge);
      head.appendChild(updatedSpan);

      section.appendChild(head);

      const meta = document.createElement('div');
      meta.className = 'source-meta';
      meta.textContent = pageUrl ? pageUrl : '';
      section.appendChild(meta);

      const content = document.createElement('div');
      content.className = 'source-content';
      section.appendChild(content);

      container.appendChild(section);
      return content;
    }

    function renderSubsection(contentEl, srcId, s, html) {
      const wrap = document.createElement('div');
      wrap.className = 'subsection';
      wrap.id = `${srcId}--sec-${s.index}`;

      const h3 = document.createElement('h3');
      h3.textContent = s.line;

      const body = document.createElement('div');
      body.innerHTML = html;

      wrap.appendChild(h3);
      wrap.appendChild(body);
      contentEl.appendChild(wrap);
    }

    function slugify(str) {
      return (str || '').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,64);
    }

    // --- Orchestration ---
    async function render() {
      try {
        const urlsRes = await fetch('./urls.json');
        if (!urlsRes.ok) throw new Error('Missing urls.json');
        const urls = await urlsRes.json();
        TOC.innerHTML = ''; // clear loading

        for (const url of urls) {
          const title = urlToTitle(url);
          const srcId = `src-${slugify(title)}`;

          // Sections + meta in parallel
          const [sections, meta] = await Promise.all([
            getSections(title),
            getPageMeta(title)
          ]);

          addTOCSourceBlock(srcId, title, sections);

          const contentEl = renderSourceHeader(
            TARGET,
            srcId,
            title,
            meta.url || url,
            meta.updated
          );

          // Filter optional
          const sectionList = (HEADERS_TO_INCLUDE)
            ? sections.filter(s => HEADERS_TO_INCLUDE.includes(s.index))
            : sections;

          // Stream sections sequentially to keep order
          for (const s of sectionList) {
            try {
              const { html } = await getSectionHTML(title, s.index);
              const cleaned = sanitizeAndRewrite(html, 'https://en.wikipedia.org');
              if (cleaned.trim()) renderSubsection(contentEl, srcId, s, cleaned);
            } catch (err) {
              const e = document.createElement('div');
              e.className = 'error';
              e.textContent = `Section “${s.line}” failed to load: ${err.message}`;
              contentEl.appendChild(e);
            }
          }
        }

        if (!urls?.length) {
          TOC.innerHTML = '<p class="error">No sources in <code>urls.json</code>.</p>';
        }
      } catch (err) {
        TOC.innerHTML = `<p class="error">Failed to initialize: ${err.message}</p>`;
      }
    }

    render();
  </script>

  <!--
    Sample urls.json (place next to this file):

    [
      "https://en.wikipedia.org/wiki/Business",
      "https://en.wikipedia.org/wiki/Corporate_governance",
      "https://en.wikipedia.org/wiki/Business_ethics",
      "https://en.wikipedia.org/wiki/Project_management",
      "https://en.wikipedia.org/wiki/Financial_accounting"
    ]
  -->
</body>
</html>
