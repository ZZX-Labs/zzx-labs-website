<!-- __partials/runtime/runtime.html -->
<!-- DROP-IN: deterministic runtime boot + prefix-safe CSS/JS injection
     Guarantees:
     - CSS for HUD/widget primitives is present BEFORE widgets mount
     - widget-core initializes only AFTER CSS and DOM are ready
     - avoids double-loads
-->

<div data-runtime-root>
  <!-- Controls bar is rendered by your runtime widget (runtime/widget.html), not here. -->
</div>

<script>
(function () {
  const W = window;

  // -------------------------
  // Prefix-safe path builder
  // -------------------------
  function prefix() {
    const p = W.ZZX && typeof W.ZZX.PREFIX === "string" ? W.ZZX.PREFIX : "";
    if (!p || p === "/") return "";
    return p.replace(/\/+$/, "");
  }
  function u(path) { return prefix() + path; }

  // -------------------------
  // Ensure CSS (once)
  // -------------------------
  function ensureCSS(href, key) {
    if (document.querySelector(`link[data-zzx-css="${key}"]`)) return Promise.resolve(true);

    return new Promise((resolve) => {
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = href;
      link.setAttribute("data-zzx-css", key);
      link.onload = () => resolve(true);
      link.onerror = () => resolve(false);
      document.head.appendChild(link);
    });
  }

  // -------------------------
  // Ensure JS (once)
  // -------------------------
  function ensureScript(src, key) {
    if (document.querySelector(`script[data-zzx-js="${key}"]`)) return Promise.resolve(true);

    return new Promise((resolve) => {
      const s = document.createElement("script");
      s.src = src;
      s.defer = true;
      s.setAttribute("data-zzx-js", key);
      s.onload = () => resolve(true);
      s.onerror = () => resolve(false);
      document.body.appendChild(s);
    });
  }

  // -------------------------
  // Boot sequence
  // -------------------------
  async function boot() {
    // 1) Load CSS primitives REQUIRED for ticker + cards + rail + HUD handle
    //    (these must exist before any widget HTML is injected)
    await ensureCSS(u("/__partials/bitcoin-ticker-widget.css"), "btc-wrapper");
    await ensureCSS(u("/__partials/widgets/widget-core.css"), "widget-core");

    // 2) Load widget core (mount engine)
    await ensureScript(u("/__partials/widgets/widget-core.js"), "widget-core");

    // 3) Load HUD state + runtime binding (the code that makes Full/Ticker/Hide/Reset work)
    //    If your site already includes these elsewhere, this will no-op due to data keys.
    await ensureScript(u("/__partials/widgets/runtime/hud-state.js"), "hud-state");
    await ensureScript(u("/__partials/widgets/runtime/widget.js"), "runtime-widget");

    // 4) Kick widget mounting only when the frame is ready
    //    (partials-loader emits zzx:partials:ready; if already fired, start immediately)
    const startWidgets = () => {
      try {
        // widget-core should expose a mount/boot entry; if not, it self-boots.
        if (W.ZZXWidgetsCore && typeof W.ZZXWidgetsCore.boot === "function") {
          W.ZZXWidgetsCore.boot();
        }
      } catch (_) {}
    };

    let started = false;
    function startOnce() {
      if (started) return;
      started = true;
      startWidgets();
    }

    W.addEventListener("zzx:frame:ready", startOnce, { once: true });
    W.addEventListener("zzx:partials:ready", startOnce, { once: true });

    // Fallback: if events never fire, start after a short tick
    setTimeout(startOnce, 50);
  }

  boot();
})();
</script>
