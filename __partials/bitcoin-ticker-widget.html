<!-- __partials/bitcoin-ticker-widget.html (WRAPPER ONLY) -->
<!-- DROP-IN REPLACEMENT: replaces “Show Bitcoin HUD” text with PNG icon button,
     adds ESC close behavior without changing layout/slots/content order.

     Behavior:
     - Handle is ALWAYS visible when HUD hidden, as before.
     - Click icon toggles HUD (show when hidden, hide when shown).
     - ESC key hides HUD (same as clicking Hide), if HUD is currently visible.
     - No dependency on extra JS files; uses your existing hud-state.js API if present.
-->

<!-- HUD handle: ALWAYS visible even if HUD is hidden -->
<div class="zzx-hud-handle" data-hud-handle>
  <button
    type="button"
    class="zzx-hud-show"
    data-hud-show
    aria-label="Toggle Bitcoin HUD"
    title="Toggle Bitcoin HUD"
    style="display:inline-flex;align-items:center;justify-content:center;border:0;background:transparent;padding:0;cursor:pointer;"
  >
    <!-- PNG icon (hamburger-style). Put your real file here. -->
    <img
      src="/static/images/icons/hud.png"
      alt="HUD"
      width="28"
      height="28"
      decoding="async"
      loading="eager"
      style="display:block;opacity:.95"
      onerror="this.style.display='none';this.nextElementSibling.style.display='inline';"
    />
    <!-- Text fallback if icon missing -->
    <span style="display:none;font-size:12px;opacity:.9;line-height:1;">
      HUD
    </span>
  </button>
</div>

<!-- HUD root (the thing that gets hidden/collapsed) -->
<div class="btc-rail" id="btc-rail" data-hud-root role="region" aria-label="Bitcoin dashboard widgets">

  <!-- runtime FIRST: it binds buttons + state -->
  <div class="btc-slot" data-widget="runtime"></div>

  <div class="btc-slot" data-widget="bitcoin-ticker"></div>

  <div class="btc-slot" data-widget="price-24h"></div>
  <div class="btc-slot" data-widget="volume-24h"></div>

  <div class="btc-slot" data-widget="hashrate"></div>
  <div class="btc-slot" data-widget="hashrate-by-nation"></div>

  <div class="btc-slot" data-widget="nodes"></div>
  <div class="btc-slot" data-widget="nodes-by-nation"></div>

  <div class="btc-slot" data-widget="lightning"></div>
  <div class="btc-slot" data-widget="lightning-detail"></div>

  <div class="btc-slot" data-widget="mempool"></div>
  <div class="btc-slot" data-widget="fees"></div>

  <div class="btc-slot" data-widget="mempool-goggles"></div>

  <div class="btc-slot" data-widget="tip"></div>
  <div class="btc-slot" data-widget="drift"></div>

  <div class="btc-slot" data-widget="intel"></div>
  <div class="btc-slot" data-widget="btc-intel"></div>

  <div class="btc-slot" data-widget="btc-repo"></div>
  <div class="btc-slot" data-widget="btc-news"></div>

  <div class="btc-slot" data-widget="satoshi-quote"></div>

  <div class="btc-slot" data-widget="btc-halving-suite"></div>

  <div class="btc-slot" data-widget="btc-mined"></div>
  <div class="btc-slot" data-widget="btc-to-mine"></div>

  <div class="btc-slot" data-widget="btc-blockexplorer"></div>
  <div class="btc-slot" data-widget="btc-notabletxs"></div>

  <div class="btc-slot" data-widget="bitrng"></div>

  <div class="btc-slot" data-widget="btc-stolen"></div>
  <div class="btc-slot" data-widget="btc-burned"></div>
  <div class="btc-slot" data-widget="btc-lost"></div>

</div>

<script>
/* Inline control shim (small + safe):
   - Uses window.ZZXHUD if present (recommended)
   - Else toggles data-hud-state on [data-hud-root] + handle visibility
   - Adds ESC-to-hide behavior
*/
(function () {
  const qs = (sel, scope) => (scope || document).querySelector(sel);

  const root   = qs("[data-hud-root]");
  const handle = qs("[data-hud-handle]");
  const btn    = qs("[data-hud-show]");

  if (!root || !handle || !btn) return;

  function apply(mode) {
    root.setAttribute("data-hud-state", mode);
    // show handle only when HUD hidden
    handle.style.display = (mode === "hidden") ? "flex" : "none";
  }

  function readMode() {
    // Prefer HUD API if available
    if (window.ZZXHUD && typeof window.ZZXHUD.read === "function") {
      const m = window.ZZXHUD.read();
      return (m === "full" || m === "ticker" || m === "hidden") ? m : "full";
    }
    const m = root.getAttribute("data-hud-state");
    return (m === "full" || m === "ticker" || m === "hidden") ? m : "full";
  }

  function writeMode(mode) {
    if (window.ZZXHUD && typeof window.ZZXHUD.write === "function") {
      window.ZZXHUD.write(mode);
      // ZZXHUD.write should already normalize + apply, but we still apply fallback.
      apply(mode);
      return;
    }
    apply(mode);
  }

  // Toggle: hidden -> full, otherwise -> hidden
  function toggle() {
    const cur = readMode();
    writeMode(cur === "hidden" ? "full" : "hidden");
  }

  // Bind once
  if (!btn.__zzxBound) {
    btn.__zzxBound = true;
    btn.addEventListener("click", toggle);
  }

  // ESC hides HUD (if visible)
  if (!document.__zzxHudEscBound) {
    document.__zzxHudEscBound = true;
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      const cur = readMode();
      if (cur !== "hidden") writeMode("hidden");
    });
  }

  // Initial apply from state
  const initial = readMode();
  apply(initial);
})();
</script>
