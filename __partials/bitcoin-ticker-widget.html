<!-- __partials/bitcoin-ticker-widget.html (WRAPPER ONLY) -->
<!-- DROP-IN: single handle + single rail + correct shim.
     Canonical modes: full | ticker-only | hidden
-->

<!-- HUD handle: shown ONLY when HUD hidden (controlled by JS) -->
<div class="zzx-hud-handle" data-hud-handle>
  <button
    type="button"
    class="zzx-hud-show"
    data-hud-show
    aria-label="Toggle Bitcoin HUD"
    title="Toggle Bitcoin HUD"
  >
    <img
      src="/static/images/icons/hud.png"
      alt="HUD"
      width="28"
      height="28"
      decoding="async"
      loading="eager"
      onerror="this.style.display='none';this.nextElementSibling.style.display='inline';"
    />
    <span class="zzx-hud-fallback">HUD</span>
  </button>
</div>

<!-- HUD root -->
<div class="btc-rail" id="btc-rail" data-hud-root data-hud-state="full" role="region" aria-label="Bitcoin dashboard widgets">

  <!-- runtime FIRST: it binds Full/Ticker/Hide/Reset -->
  <div class="btc-slot" data-widget="runtime"></div>

  <div class="btc-slot" data-widget="bitcoin-ticker"></div>

  <div class="btc-slot" data-widget="price-24h"></div>
  <div class="btc-slot" data-widget="volume-24h"></div>

  <div class="btc-slot" data-widget="hashrate"></div>
  <div class="btc-slot" data-widget="hashrate-by-nation"></div>

  <div class="btc-slot" data-widget="nodes"></div>
  <div class="btc-slot" data-widget="nodes-by-nation"></div>

  <div class="btc-slot" data-widget="lightning"></div>
  <div class="btc-slot" data-widget="lightning-detail"></div>

  <div class="btc-slot" data-widget="mempool"></div>
  <div class="btc-slot" data-widget="fees"></div>

  <div class="btc-slot" data-widget="mempool-goggles"></div>

  <div class="btc-slot" data-widget="tip"></div>
  <div class="btc-slot" data-widget="drift"></div>

  <div class="btc-slot" data-widget="intel"></div>
  <div class="btc-slot" data-widget="btc-intel"></div>

  <div class="btc-slot" data-widget="btc-repo"></div>
  <div class="btc-slot" data-widget="btc-news"></div>

  <div class="btc-slot" data-widget="satoshi-quote"></div>

  <div class="btc-slot" data-widget="btc-halving-suite"></div>

  <div class="btc-slot" data-widget="btc-mined"></div>
  <div class="btc-slot" data-widget="btc-to-mine"></div>

  <div class="btc-slot" data-widget="btc-blockexplorer"></div>
  <div class="btc-slot" data-widget="btc-notabletxs"></div>

  <div class="btc-slot" data-widget="bitrng"></div>

  <div class="btc-slot" data-widget="btc-stolen"></div>
  <div class="btc-slot" data-widget="btc-burned"></div>
  <div class="btc-slot" data-widget="btc-lost"></div>
</div>

<script>
/* Wrapper shim:
   - ONLY controls the handle icon toggle + ESC hide.
   - Does NOT bind Full/Ticker/Hide/Reset (runtime widget does that).
   - Canonical modes: full | ticker-only | hidden
*/
(function () {
  "use strict";

  const qs = (sel, scope) => (scope || document).querySelector(sel);

  const root   = qs("[data-hud-root]");
  const handle = qs("[data-hud-handle]");
  const btn    = qs("[data-hud-show]");

  if (!root || !handle || !btn) return;

  function normalize(mode){
    if (mode && typeof mode === "object" && "mode" in mode) mode = mode.mode;
    if (!mode) return "full";
    let m = String(mode).trim().toLowerCase();

    // Back-compat
    if (m === "ticker") m = "ticker-only";

    return (m === "full" || m === "ticker-only" || m === "hidden") ? m : "full";
  }

  function readMode(){
    if (window.ZZXHUD && typeof window.ZZXHUD.read === "function") {
      return normalize(window.ZZXHUD.read().mode);
    }
    return normalize(root.getAttribute("data-hud-state"));
  }

  function apply(mode){
    const m = normalize(mode);
    root.setAttribute("data-hud-state", m);

    // handle is outside root, so JS controls it explicitly
    handle.style.display = (m === "hidden") ? "flex" : "none";
  }

  function writeMode(mode){
    const m = normalize(mode);
    if (window.ZZXHUD && typeof window.ZZXHUD.write === "function") {
      window.ZZXHUD.write(m);
    }
    apply(m);
  }

  function toggle(){
    const cur = readMode();
    writeMode(cur === "hidden" ? "full" : "hidden");
  }

  if (!btn.__zzxBound) {
    btn.__zzxBound = true;
    btn.addEventListener("click", toggle);
  }

  if (!document.__zzxHudEscBound) {
    document.__zzxHudEscBound = true;
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;

      // Don't fight the Credits modal if it is open
      const cm = document.getElementById("zzx-credits-modal");
      if (cm && !cm.hidden) return;

      const cur = readMode();
      if (cur !== "hidden") writeMode("hidden");
    });
  }

  // init
  apply(readMode());
})();
</script>
